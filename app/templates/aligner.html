{% extends "base.html" %}

{% block title %}Gemini ä¸‰è¯­å¯¹é½å·¥å…·{% endblock %}

{% block head_styles %}
<style>
    /* æ ·å¼ä¸ä¹‹å‰ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œä¸ºæ–°è¾“å…¥æ¡†å¢åŠ è·¨åˆ—æ ·å¼ */
    .container { max-width: 1140px; }
    .card + .card { margin-top: 1.5rem; }
    .card-header h4 { margin-bottom: 0; }
    .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
    .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .control-group label { font-weight: 500; color: #495057; }
    .interval-group { display: flex; align-items: center; gap: 0.5rem; }
    .io-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; grid-template-areas: "doc sheet" "diag diag"; }
    #doc-group { grid-area: doc; }
    #sheet-group { grid-area: sheet; }
    #diag-group { grid-area: diag; }
    .diagnostic-mode { display: flex; align-items: center; gap: 0.5rem; background-color: #fff3cd; padding: 0.75rem; border-radius: 0.375rem; }
    .button-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
    .log-box { height: 350px; overflow-y: scroll; border: 1px solid #dee2e6; padding: 1rem; background-color: #f8f9fa; font-family: monospace; white-space: pre-wrap; border-radius: 0.375rem; }
    .status-bar { min-height: 48px; display: flex; justify-content: center; align-items: center; background-color: #e9ecef; border-radius: 5px; padding: 10px; font-size: 1.1em; font-weight: 500; margin-top: 1.5rem; }
    .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #0d6efd; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* æ–°å¢æ ·å¼ï¼Œè®©æŒ‡ä»¤è¾“å…¥æ¡†æ¨ªè·¨æ•´è¡Œ */
    .control-grid .full-width-prompt {
        grid-column: 1 / -1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="text-center mb-4">
        <h1 class="display-5">Gemini ä¸‰è¯­å¯¹é½å·¥å…·</h1>
        <p class="lead text-muted">é€šè¿‡ Google Doc å®ç°çš„è‡ªåŠ¨åŒ–ã€æ‰¹å¤„ç†å¯¹é½æµç¨‹</p>
    </div>

    <!-- ç¬¬ä¸€æ¿å—ï¼šåˆå§‹åŒ–è®¾ç½® -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h4>âš™ï¸ åˆå§‹åŒ–è®¾ç½®</h4>
        </div>
        <div class="card-body">
            <div class="control-grid">
                <div class="control-group">
                    <label for="geminiApiKey">æ‚¨çš„ Gemini API Key:</label>
                    <input type="password" class="form-control" id="geminiApiKey" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ API Key">
                </div>
                <div class="control-group">
                    <label for="model-selector">Gemini æ¨¡å‹:</label>
                    <select id="model-selector" class="form-select">
                        <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                        <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash</option>
                        <option value="gemini-pro">Gemini 1.0 Pro</option>
                        <option value="gemini-2.5-pro" selected>Gemini 2.5 Pro</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="temperature-slider">Temperature: <span id="temperature-value">0.20</span></label>
                    <input type="range" class="form-range" id="temperature-slider" min="0" max="1" step="0.05" value="0.2">
                </div>
                <div class="control-group">
                    <label for="batch-size">æ‰¹æ¬¡å¤§å° (æ®µè½æ•°):</label>
                    <input type="number" id="batch-size" class="form-control" value="1" min="1">
                </div>
                <div class="control-group">
                    <label>æ‰¹æ¬¡é—´éšæœºé—´éš” (ç§’):</label>
                    <div class="interval-group">
                        <input type="number" id="interval-min" class="form-control" value="3" min="0">
                        <span>-</span>
                        <input type="number" id="interval-max" class="form-control" value="5" min="0">
                    </div>
                </div>
                <!-- --- è¿™é‡Œæ˜¯æ ¸å¿ƒä¿®æ”¹ï¼šæ–°å¢ç³»ç»ŸæŒ‡ä»¤è¾“å…¥æ¡† --- -->
                <div class="control-group full-width-prompt">
                    <label for="systemInstruction">ç³»ç»ŸæŒ‡ä»¤ (System Prompt):</label>
                    <textarea id="systemInstruction" class="form-control" rows="8" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ç³»ç»ŸæŒ‡ä»¤..."></textarea>
                </div>
                <!-- ----------------------------------------- -->
            </div>
        </div>
    </div>

    <!-- ç¬¬äºŒæ¿å—ï¼šè¾“å…¥ä¸è¾“å‡º -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h4>ğŸ”— è¾“å…¥ä¸è¾“å‡º</h4>
        </div>
        <div class="card-body">
            <div class="io-grid">
                <div id="doc-group" class="control-group">
                    <label for="docUrl">æº Google Doc é“¾æ¥:</label>
                    <input type="url" class="form-control" id="docUrl" placeholder="ç²˜è´´ Google Doc é“¾æ¥...">
                </div>
                <div id="sheet-group" class="control-group">
                    <label for="sheetUrl">ç›®æ ‡ Google Sheet å­è¡¨é“¾æ¥:</label>
                    <input type="url" class="form-control" id="sheetUrl" placeholder="ç²˜è´´åŒ…å« #gid=... çš„å­è¡¨é“¾æ¥...">
                </div>
                <div id="diag-group" class="diagnostic-mode">
                    <input type="checkbox" id="diagnostic-mode-checkbox" class="form-check-input">
                    <label for="diagnostic-mode-checkbox" class="form-check-label">å¼€å¯è¯Šæ–­æ¨¡å¼</label>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="button-container">
        <button id="start-button" class="btn btn-success btn-lg">ğŸš€ å¼€å§‹è‡ªåŠ¨åŒ–å¤„ç†</button>
        <button id="stop-button" class="btn btn-danger btn-lg" disabled>ğŸ›‘ åœæ­¢å¤„ç†</button>
    </div>

    <!-- çŠ¶æ€å’Œæ—¥å¿— -->
    <div id="status-bar" class="status-bar">å‡†å¤‡å°±ç»ª</div>
    <div class="mt-3">
        <h5>å¤„ç†æ—¥å¿—</h5>
        <div id="logBox" class="log-box">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // JavaScript éƒ¨åˆ†ä¸ä¸Šä¸€ç‰ˆå®Œå…¨ç›¸åŒï¼Œåªéœ€åœ¨ settingsInputs ä¸­åŠ å…¥ systemInstruction
    const startButton = document.getElementById('start-button');
    const stopButton = document.getElementById('stop-button');
    const logBox = document.getElementById('logBox');
    const statusBar = document.getElementById('status-bar');
    const temperatureSlider = document.getElementById('temperature-slider');
    const temperatureValueSpan = document.getElementById('temperature-value');
    const diagnosticCheckbox = document.getElementById('diagnostic-mode-checkbox');

    const settingsInputs = {
        geminiApiKey: document.getElementById('geminiApiKey'),
        model: document.getElementById('model-selector'),
        temperature: temperatureSlider,
        batchSize: document.getElementById('batch-size'),
        intervalMin: document.getElementById('interval-min'),
        intervalMax: document.getElementById('interval-max'),
        systemInstruction: document.getElementById('systemInstruction'), // <-- åŠ å…¥è¿™ä¸€è¡Œ
        docUrl: document.getElementById('docUrl'),
        sheetUrl: document.getElementById('sheetUrl')
    };
    const SETTINGS_KEY = 'alignerToolSettings_ServiceAccount_v7'; // æ›´æ–°Key

    let isProcessing = false;

    function saveSettings() {
        const currentSettings = {};
        for (const key in settingsInputs) { currentSettings[key] = settingsInputs[key].value; }
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
    }

    function loadSettings() {
        const savedSettingsJSON = localStorage.getItem(SETTINGS_KEY);
        if (savedSettingsJSON) {
            const savedSettings = JSON.parse(savedSettingsJSON);
            for (const key in savedSettings) { if (settingsInputs[key]) { settingsInputs[key].value = savedSettings[key]; } }
            temperatureValueSpan.textContent = parseFloat(settingsInputs.temperature.value).toFixed(2);
        }
    }
    
    document.addEventListener('DOMContentLoaded', loadSettings);
    startButton.addEventListener('click', startAutomation);
    stopButton.addEventListener('click', stopAutomation);
    temperatureSlider.addEventListener('input', () => { temperatureValueSpan.textContent = parseFloat(settingsInputs.temperature.value).toFixed(2); });
    Object.values(settingsInputs).forEach(input => {
        const eventType = (input.type.match(/range|text|password|url|number|textarea/)) ? 'input' : 'change';
        input.addEventListener(eventType, saveSettings);
    });

    function stopAutomation() {
        if (isProcessing) {
            isProcessing = false;
            statusBar.innerHTML = '<span>æ­£åœ¨å‘é€åœæ­¢ä¿¡å·...</span>';
            stopButton.disabled = true;
        }
    }

    function updateButtonStates(processing) {
        isProcessing = processing;
        startButton.disabled = processing;
        stopButton.disabled = !processing;
    }

    function logMessage(message) {
        logBox.textContent += message + '\n';
        logBox.scrollTop = logBox.scrollHeight;
    }
    
    function startAutomation() {
        if (isProcessing) return;
        updateButtonStates(true);
        logBox.textContent = '';
        logMessage('æ­£åœ¨å¯åŠ¨ä»»åŠ¡...');
        statusBar.innerHTML = '<div class="loader"></div><span>æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</span>';

        const params = {
            gemini_api_key: settingsInputs.geminiApiKey.value,
            doc_url: settingsInputs.docUrl.value,
            sheet_url: settingsInputs.sheetUrl.value,
            model_name: settingsInputs.model.value,
            temperature: parseFloat(settingsInputs.temperature.value),
            batch_size: parseInt(settingsInputs.batchSize.value, 10),
            interval_min: parseInt(settingsInputs.intervalMin.value, 10),
            interval_max: parseInt(settingsInputs.intervalMax.value, 10),
            system_instruction: settingsInputs.systemInstruction.value, // <-- åŠ å…¥è¿™ä¸€è¡Œ
            diagnostic_mode: diagnosticCheckbox.checked
        };
        
        if (!params.gemini_api_key) {
            alert('è¯·è¾“å…¥æ‚¨çš„ Gemini API Keyã€‚');
            updateButtonStates(false);
            return;
        }
        if (!params.system_instruction) { // æ–°å¢æ£€æŸ¥
            alert('è¯·è¾“å…¥ç³»ç»ŸæŒ‡ä»¤ã€‚');
            updateButtonStates(false);
            return;
        }
        if (!params.doc_url || !params.sheet_url) {
            alert('è¯·æä¾› Google Doc å’Œ Google Sheet çš„é“¾æ¥ã€‚');
            updateButtonStates(false);
            return;
        }

        fetch('/process_doc_to_sheet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(params)
        })
        .then(response => {
            if (!response.ok) { throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}. è¯·æ£€æŸ¥åç«¯æ—¥å¿—ã€‚`); }
            if (!response.body) { throw new Error('å“åº”æµä¸å¯ç”¨ã€‚'); }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function processStream() {
                if (!isProcessing) {
                    reader.cancel();
                    logMessage('\nå¤„ç†å·²åœæ­¢ã€‚');
                    statusBar.innerHTML = '<span>å¤„ç†å·²åœæ­¢ã€‚</span>';
                    updateButtonStates(false);
                    return;
                }
                reader.read().then(({ done, value }) => {
                    if (done) {
                        if (isProcessing) {
                            logMessage('\nä»»åŠ¡æµç»“æŸã€‚');
                            statusBar.innerHTML = '<span>ä»»åŠ¡å®Œæˆï¼</span>';
                        }
                        updateButtonStates(false);
                        return;
                    }
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6).trim();
                            logMessage(message);
                            statusBar.innerHTML = `<span>${message.split('\n')[0]}</span>`;
                        }
                    });
                    processStream();
                });
            }
            processStream();
        })
        .catch(error => {
            logMessage(`\n[è‡´å‘½é”™è¯¯] è¯·æ±‚å¤±è´¥: ${error.message}`);
            statusBar.innerHTML = `<span>è¯·æ±‚å¤±è´¥ï¼</span>`;
            updateButtonStates(false);
        });
    }
</script>
{% endblock %}